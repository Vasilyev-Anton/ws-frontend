(()=>{"use strict";class e{constructor(e){this.nickname=e}init(){this.messageForm=document.getElementById("message-form"),this.messageInput=document.getElementById("message-input"),this.messagesContainer=document.getElementById("messages-container"),this.usersList=document.getElementById("users-list"),this.messageForm&&this.messageInput&&this.messagesContainer&&this.usersList?(this.messageForm.addEventListener("submit",this.handleSubmit.bind(this)),this.messageInput.addEventListener("keydown",this.handleEnterPress.bind(this))):console.error("ChatUI cannot initialize because some elements are missing.")}handleSubmit(e){e.preventDefault(),this.sendMessage()}handleEnterPress(e){"Enter"===e.key&&(e.preventDefault(),this.sendMessage())}sendMessage(){const e=this.messageInput.value.trim();""!==e&&(this.emit("send-message",{type:"send",user:this.nickname,content:e}),this.messageInput.value="")}updateUsersList(e){this.usersList.innerHTML="",e.forEach((e=>{const t=document.createElement("li");t.textContent=e,e===this.nickname&&(t.textContent="You",t.classList.add("current-user")),t.classList.add("user-item"),this.usersList.appendChild(t)}))}updateMessages(e){e.forEach((e=>{const t=document.createElement("div"),s=document.createElement("span");s.textContent=e.user===this.nickname?"You":e.user,s.classList.add("message-user");const n=document.createElement("span");n.textContent=", ";const i=document.createElement("span");i.textContent=e.time,i.classList.add("message-time");const a=document.createElement("br"),o=document.createTextNode(e.content);t.appendChild(s),t.appendChild(n),t.appendChild(i),t.appendChild(a),t.appendChild(o),t.classList.add(e.user===this.nickname?"message-own":"message-other"),this.messagesContainer.appendChild(t),this.scrollToBottom()}))}scrollToBottom(){setTimeout((()=>{this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}),0)}disconnect(){this.emit("send-message",{type:"exit",user:this.nickname})}on(e,t){this.callbacks=this.callbacks||{},this.callbacks[e]=this.callbacks[e]||[],this.callbacks[e].push(t)}emit(e,t){const s=this.callbacks&&this.callbacks[e];s&&s.forEach((e=>e(t)))}}class t{constructor(e,t,s,n){this.socket=new WebSocket(e),this.socket.addEventListener("open",s),this.socket.addEventListener("message",(e=>{const s=JSON.parse(e.data);"history"===s.type?s.content.forEach((e=>{t(e,!0)})):t(s)})),this.socket.addEventListener("close",n)}send(e){this.socket.send(JSON.stringify(e))}close(){this.socket.close()}}const s=new class{constructor(e){this.url=e}async registerUser(e){const t=await fetch(`${this.url}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname:e})});if(!t.ok){const e=await t.json();throw new Error(e.status)}return t.json()}async sendMessage(e){if(!(await fetch(`${this.url}/send`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e})})).ok)throw new Error("Failed to send message")}}("https://my-first-project-idcp.onrender.com"),n=new class{constructor(){this.registrationForm=this.createRegistrationForm()}createRegistrationForm(){const e=document.createElement("form"),t=document.createElement("label");t.textContent="Выберите псевдоним",e.appendChild(t);const s=document.createElement("input");s.type="text",s.id="nickname",t.setAttribute("for","nickname"),e.appendChild(s);const n=document.createElement("button");return n.type="submit",n.textContent="Продолжить",e.appendChild(n),e}createMessageForm(){const e=document.createElement("form");e.id="message-form";const t=document.createElement("input");return t.id="message-input",t.type="text",e.appendChild(t),e}createMessagesContainer(){const e=document.createElement("div");return e.id="messages-container",e}createUsersList(){const e=document.createElement("ul");return e.id="users-list",e}appendToDOM(){document.body.appendChild(this.registrationForm)}appendMessageFormAndUsersListToDOM(){this.usersList=this.createUsersList();const e=document.createElement("div");e.id="chat-container",this.messagesContainer=this.createMessagesContainer(),e.appendChild(this.messagesContainer),this.messageForm=this.createMessageForm(),e.appendChild(this.messageForm),document.body.appendChild(this.usersList),document.body.appendChild(e)}removeRegistrationForm(){document.body.contains(this.registrationForm)&&document.body.removeChild(this.registrationForm)}removeMessageForm(){document.body.contains(this.messageForm)&&document.body.removeChild(this.messageForm)}};let i;n.appendToDOM(),document.addEventListener("DOMContentLoaded",(()=>{const{registrationForm:a}=n;a.addEventListener("submit",(async o=>{o.preventDefault();const r=a.querySelector('input[type="text"]').value.trim();if(r)try{const a=await s.registerUser(r);if("Псевдоним уже используется."===a.status)alert("Такой псевдоним уже занят, попробуйте другой.");else if("OK"===a.status){n.removeRegistrationForm(),i=new e(r),n.appendMessageFormAndUsersListToDOM(),i.init();const s=new t("wss://my-first-project-idcp.onrender.com/ws",(e=>{"message"===e.type&&(console.log(e),i.updateMessages([e])),"users"===e.type&&i.updateUsersList(e.users)}),(()=>{console.log("WebSocket соединение открыто"),s.send({type:"register",user:r})}),(()=>{console.log("WebSocket соединение закрыто")}));i.on("send-message",(e=>{s.send({type:"send",user:i.nickname,content:e.content})})),window.addEventListener("beforeunload",(()=>i.disconnect())),i.emit("load")}else alert(`Ошибка регистрации: ${a.message}`)}catch(e){alert(`Ошибка регистрации: ${e.message}`)}else alert("Пожалуйста, введите псевдоним.")}))}))})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QUNaNkMsRUFBT2hFLGVBQWUsQ0FBQ21CLEtBRVAsVUFBZEEsRUFBS2hDLE1BQ1A2RSxFQUFPMUUsZ0JBQWdCNkIsRUFBSzVCLE1BQzlCLElBRUYsS0FDRWQsUUFBUTZGLElBQUksZ0NBQ1pELEVBQVd4QyxLQUFLLENBQ2QxQyxLQUFNLFdBQ05DLEtBQU14QixHQUNOLElBRUosS0FDRWEsUUFBUTZGLElBQUksK0JBQStCLElBRy9DTixFQUFPakQsR0FBRyxnQkFBaUJoQyxJQUN6QnNGLEVBQVd4QyxLQUFLLENBQ2QxQyxLQUFNLE9BQ05DLEtBQU00RSxFQUFPcEcsU0FDYnlCLFFBQVNOLEVBQVFNLFNBQ2pCLElBRUprRixPQUFPbEcsaUJBQWlCLGdCQUFnQixJQUFNMkYsRUFBT2xELGVBQ3JEa0QsRUFBTzlFLEtBQUssT0FDZCxNQUNFa0YsTUFBTyx1QkFBc0JsQyxFQUFTbkQsVUFFMUMsQ0FBRSxNQUFPTCxHQUNQMEYsTUFBTyx1QkFBc0IxRixFQUFNSyxVQUNyQyxNQWxERXFGLE1BQU0saUNBa0RSLEdBQ0EsRyIsInNvdXJjZXMiOlsid2VicGFjazovL3dzLWZyb250ZW5kLy4vc3JjL2pzL0NoYXRVSS5qcyIsIndlYnBhY2s6Ly93cy1mcm9udGVuZC8uL3NyYy9qcy9DaGF0V2ViU29ja2V0LmpzIiwid2VicGFjazovL3dzLWZyb250ZW5kLy4vc3JjL2pzL2FwcC5qcyIsIndlYnBhY2s6Ly93cy1mcm9udGVuZC8uL3NyYy9qcy9DaGF0QVBJLmpzIiwid2VicGFjazovL3dzLWZyb250ZW5kLy4vc3JjL2pzL0NyZWF0ZURPTUVsZW1lbnRzLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIG5vLWNvbnNvbGUgKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENoYXRVSSB7XG4gIGNvbnN0cnVjdG9yKG5pY2tuYW1lKSB7XG4gICAgdGhpcy5uaWNrbmFtZSA9IG5pY2tuYW1lO1xuICB9XG5cbiAgaW5pdCgpIHtcbiAgICB0aGlzLm1lc3NhZ2VGb3JtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lc3NhZ2UtZm9ybScpO1xuICAgIHRoaXMubWVzc2FnZUlucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lc3NhZ2UtaW5wdXQnKTtcbiAgICB0aGlzLm1lc3NhZ2VzQ29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lc3NhZ2VzLWNvbnRhaW5lcicpO1xuICAgIHRoaXMudXNlcnNMaXN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VzZXJzLWxpc3QnKTtcblxuICAgIGlmICh0aGlzLm1lc3NhZ2VGb3JtICYmIHRoaXMubWVzc2FnZUlucHV0ICYmIHRoaXMubWVzc2FnZXNDb250YWluZXIgJiYgdGhpcy51c2Vyc0xpc3QpIHtcbiAgICAgIHRoaXMubWVzc2FnZUZvcm0uYWRkRXZlbnRMaXN0ZW5lcignc3VibWl0JywgdGhpcy5oYW5kbGVTdWJtaXQuYmluZCh0aGlzKSk7XG4gICAgICB0aGlzLm1lc3NhZ2VJbnB1dC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdGhpcy5oYW5kbGVFbnRlclByZXNzLmJpbmQodGhpcykpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdDaGF0VUkgY2Fubm90IGluaXRpYWxpemUgYmVjYXVzZSBzb21lIGVsZW1lbnRzIGFyZSBtaXNzaW5nLicpO1xuICAgIH1cbiAgfVxuXG4gIGhhbmRsZVN1Ym1pdChldmVudCkge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgdGhpcy5zZW5kTWVzc2FnZSgpO1xuICB9XG5cbiAgaGFuZGxlRW50ZXJQcmVzcyhldmVudCkge1xuICAgIGlmIChldmVudC5rZXkgPT09ICdFbnRlcicpIHtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICB0aGlzLnNlbmRNZXNzYWdlKCk7XG4gICAgfVxuICB9XG5cbiAgc2VuZE1lc3NhZ2UoKSB7XG4gICAgY29uc3QgbWVzc2FnZSA9IHRoaXMubWVzc2FnZUlucHV0LnZhbHVlLnRyaW0oKTtcbiAgICBpZiAobWVzc2FnZSAhPT0gJycpIHtcbiAgICAgIHRoaXMuZW1pdCgnc2VuZC1tZXNzYWdlJywgeyB0eXBlOiAnc2VuZCcsIHVzZXI6IHRoaXMubmlja25hbWUsIGNvbnRlbnQ6IG1lc3NhZ2UgfSk7XG4gICAgICB0aGlzLm1lc3NhZ2VJbnB1dC52YWx1ZSA9ICcnO1xuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZVVzZXJzTGlzdCh1c2Vycykge1xuICAgIHRoaXMudXNlcnNMaXN0LmlubmVySFRNTCA9ICcnO1xuICAgIHVzZXJzLmZvckVhY2goKHVzZXIpID0+IHtcbiAgICAgIGNvbnN0IHVzZXJJdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTtcbiAgICAgIHVzZXJJdGVtLnRleHRDb250ZW50ID0gdXNlcjtcbiAgICAgIGlmICh1c2VyID09PSB0aGlzLm5pY2tuYW1lKSB7XG4gICAgICAgIHVzZXJJdGVtLnRleHRDb250ZW50ID0gJ1lvdSc7XG4gICAgICAgIHVzZXJJdGVtLmNsYXNzTGlzdC5hZGQoJ2N1cnJlbnQtdXNlcicpO1xuICAgICAgfVxuICAgICAgdXNlckl0ZW0uY2xhc3NMaXN0LmFkZCgndXNlci1pdGVtJyk7XG4gICAgICB0aGlzLnVzZXJzTGlzdC5hcHBlbmRDaGlsZCh1c2VySXRlbSk7XG4gICAgfSk7XG4gIH1cblxuICB1cGRhdGVNZXNzYWdlcyhtZXNzYWdlcykge1xuICAgIG1lc3NhZ2VzLmZvckVhY2goKG1lc3NhZ2UpID0+IHtcbiAgICAgIGNvbnN0IG1lc3NhZ2VEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgIGNvbnN0IHVzZXJTcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xuICAgICAgdXNlclNwYW4udGV4dENvbnRlbnQgPSBtZXNzYWdlLnVzZXIgPT09IHRoaXMubmlja25hbWUgPyAnWW91JyA6IG1lc3NhZ2UudXNlcjtcbiAgICAgIHVzZXJTcGFuLmNsYXNzTGlzdC5hZGQoJ21lc3NhZ2UtdXNlcicpO1xuICAgICAgY29uc3QgY29tbWFUZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xuICAgICAgY29tbWFUZXh0LnRleHRDb250ZW50ID0gJywgJztcbiAgICAgIGNvbnN0IHRpbWVTcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xuICAgICAgdGltZVNwYW4udGV4dENvbnRlbnQgPSBtZXNzYWdlLnRpbWU7XG4gICAgICB0aW1lU3Bhbi5jbGFzc0xpc3QuYWRkKCdtZXNzYWdlLXRpbWUnKTtcbiAgICAgIGNvbnN0IGxpbmVCcmVhayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2JyJyk7XG5cbiAgICAgIGNvbnN0IGNvbnRlbnRUZXh0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUobWVzc2FnZS5jb250ZW50KTtcblxuICAgICAgbWVzc2FnZURpdi5hcHBlbmRDaGlsZCh1c2VyU3Bhbik7XG4gICAgICBtZXNzYWdlRGl2LmFwcGVuZENoaWxkKGNvbW1hVGV4dCk7XG4gICAgICBtZXNzYWdlRGl2LmFwcGVuZENoaWxkKHRpbWVTcGFuKTtcbiAgICAgIG1lc3NhZ2VEaXYuYXBwZW5kQ2hpbGQobGluZUJyZWFrKTtcbiAgICAgIG1lc3NhZ2VEaXYuYXBwZW5kQ2hpbGQoY29udGVudFRleHQpO1xuXG4gICAgICBtZXNzYWdlRGl2LmNsYXNzTGlzdC5hZGQobWVzc2FnZS51c2VyID09PSB0aGlzLm5pY2tuYW1lID8gJ21lc3NhZ2Utb3duJyA6ICdtZXNzYWdlLW90aGVyJyk7XG5cbiAgICAgIHRoaXMubWVzc2FnZXNDb250YWluZXIuYXBwZW5kQ2hpbGQobWVzc2FnZURpdik7XG4gICAgICB0aGlzLnNjcm9sbFRvQm90dG9tKCk7XG4gICAgfSk7XG4gIH1cblxuICBzY3JvbGxUb0JvdHRvbSgpIHtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMubWVzc2FnZXNDb250YWluZXIuc2Nyb2xsVG9wID0gdGhpcy5tZXNzYWdlc0NvbnRhaW5lci5zY3JvbGxIZWlnaHQ7XG4gICAgfSwgMCk7XG4gIH1cblxuICBkaXNjb25uZWN0KCkge1xuICAgIHRoaXMuZW1pdCgnc2VuZC1tZXNzYWdlJywgeyB0eXBlOiAnZXhpdCcsIHVzZXI6IHRoaXMubmlja25hbWUgfSk7XG4gIH1cblxuICBvbihldmVudCwgY2FsbGJhY2spIHtcbiAgICB0aGlzLmNhbGxiYWNrcyA9IHRoaXMuY2FsbGJhY2tzIHx8IHt9O1xuICAgIHRoaXMuY2FsbGJhY2tzW2V2ZW50XSA9IHRoaXMuY2FsbGJhY2tzW2V2ZW50XSB8fCBbXTtcbiAgICB0aGlzLmNhbGxiYWNrc1tldmVudF0ucHVzaChjYWxsYmFjayk7XG4gIH1cblxuICBlbWl0KGV2ZW50LCBkYXRhKSB7XG4gICAgY29uc3QgY2FsbGJhY2tzID0gdGhpcy5jYWxsYmFja3MgJiYgdGhpcy5jYWxsYmFja3NbZXZlbnRdO1xuICAgIGlmIChjYWxsYmFja3MpIHtcbiAgICAgIGNhbGxiYWNrcy5mb3JFYWNoKChjYWxsYmFjaykgPT4gY2FsbGJhY2soZGF0YSkpO1xuICAgIH1cbiAgfVxufVxuIiwiZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ2hhdFdlYlNvY2tldCB7XG4gIGNvbnN0cnVjdG9yKHVybCwgb25NZXNzYWdlLCBvbk9wZW4sIG9uQ2xvc2UpIHtcbiAgICB0aGlzLnNvY2tldCA9IG5ldyBXZWJTb2NrZXQodXJsKTtcbiAgICB0aGlzLnNvY2tldC5hZGRFdmVudExpc3RlbmVyKCdvcGVuJywgb25PcGVuKTtcbiAgICB0aGlzLnNvY2tldC5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgKGV2ZW50KSA9PiB7XG4gICAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShldmVudC5kYXRhKTtcbiAgICAgIGlmIChkYXRhLnR5cGUgPT09ICdoaXN0b3J5Jykge1xuICAgICAgICBkYXRhLmNvbnRlbnQuZm9yRWFjaCgobWVzc2FnZSkgPT4ge1xuICAgICAgICAgIG9uTWVzc2FnZShtZXNzYWdlLCB0cnVlKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvbk1lc3NhZ2UoZGF0YSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy5zb2NrZXQuYWRkRXZlbnRMaXN0ZW5lcignY2xvc2UnLCBvbkNsb3NlKTtcbiAgfVxuXG4gIHNlbmQoZGF0YSkge1xuICAgIHRoaXMuc29ja2V0LnNlbmQoSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xuICB9XG5cbiAgY2xvc2UoKSB7XG4gICAgdGhpcy5zb2NrZXQuY2xvc2UoKTtcbiAgfVxufVxuIiwiLyogZXNsaW50LWRpc2FibGUgbm8tY29uc29sZSAqL1xuLyogZXNsaW50LWRpc2FibGUgbm8tYWxlcnQgKi9cbmltcG9ydCBDcmVhdGVET01FbGVtZW50cyBmcm9tICcuL0NyZWF0ZURPTUVsZW1lbnRzJztcbmltcG9ydCBDaGF0VUkgZnJvbSAnLi9DaGF0VUknO1xuaW1wb3J0IENoYXRBUEkgZnJvbSAnLi9DaGF0QVBJJztcbmltcG9ydCBDaGF0V2ViU29ja2V0IGZyb20gJy4vQ2hhdFdlYlNvY2tldCc7XG5cbmNvbnN0IGNoYXRBUEkgPSBuZXcgQ2hhdEFQSSgnaHR0cHM6Ly9teS1maXJzdC1wcm9qZWN0LWlkY3Aub25yZW5kZXIuY29tJyk7XG5cbmNvbnN0IGRvbUVsZW1lbnRzID0gbmV3IENyZWF0ZURPTUVsZW1lbnRzKCk7XG5kb21FbGVtZW50cy5hcHBlbmRUb0RPTSgpO1xuXG5sZXQgY2hhdFVJO1xuXG5jb25zdCBzaG93UmVnaXN0cmF0aW9uV2luZG93ID0gKCkgPT4ge1xuICBjb25zdCB7IHJlZ2lzdHJhdGlvbkZvcm0gfSA9IGRvbUVsZW1lbnRzO1xuICByZWdpc3RyYXRpb25Gb3JtLmFkZEV2ZW50TGlzdGVuZXIoJ3N1Ym1pdCcsIGFzeW5jIChldmVudCkgPT4ge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICBjb25zdCB1c2VybmFtZUlucHV0ID0gcmVnaXN0cmF0aW9uRm9ybS5xdWVyeVNlbGVjdG9yKCdpbnB1dFt0eXBlPVwidGV4dFwiXScpO1xuICAgIGNvbnN0IG5pY2tuYW1lID0gdXNlcm5hbWVJbnB1dC52YWx1ZS50cmltKCk7XG5cbiAgICBpZiAoIW5pY2tuYW1lKSB7XG4gICAgICBhbGVydCgn0J/QvtC20LDQu9GD0LnRgdGC0LAsINCy0LLQtdC00LjRgtC1INC/0YHQtdCy0LTQvtC90LjQvC4nKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgY2hhdEFQSS5yZWdpc3RlclVzZXIobmlja25hbWUpO1xuXG4gICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSAn0J/RgdC10LLQtNC+0L3QuNC8INGD0LbQtSDQuNGB0L/QvtC70YzQt9GD0LXRgtGB0Y8uJykge1xuICAgICAgICBhbGVydCgn0KLQsNC60L7QuSDQv9GB0LXQstC00L7QvdC40Lwg0YPQttC1INC30LDQvdGP0YIsINC/0L7Qv9GA0L7QsdGD0LnRgtC1INC00YDRg9Cz0L7QuS4nKTtcbiAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSAnT0snKSB7XG4gICAgICAgIGRvbUVsZW1lbnRzLnJlbW92ZVJlZ2lzdHJhdGlvbkZvcm0oKTtcbiAgICAgICAgY2hhdFVJID0gbmV3IENoYXRVSShuaWNrbmFtZSk7XG4gICAgICAgIGRvbUVsZW1lbnRzLmFwcGVuZE1lc3NhZ2VGb3JtQW5kVXNlcnNMaXN0VG9ET00oKTtcbiAgICAgICAgY2hhdFVJLmluaXQoKTtcblxuICAgICAgICBjb25zdCBjaGF0U29ja2V0ID0gbmV3IENoYXRXZWJTb2NrZXQoXG4gICAgICAgICAgJ3dzczovL215LWZpcnN0LXByb2plY3QtaWRjcC5vbnJlbmRlci5jb20vd3MnLFxuICAgICAgICAgIChkYXRhKSA9PiB7XG4gICAgICAgICAgICBpZiAoZGF0YS50eXBlID09PSAnbWVzc2FnZScpIHtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coZGF0YSk7XG4gICAgICAgICAgICAgIGNoYXRVSS51cGRhdGVNZXNzYWdlcyhbZGF0YV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGRhdGEudHlwZSA9PT0gJ3VzZXJzJykge1xuICAgICAgICAgICAgICBjaGF0VUkudXBkYXRlVXNlcnNMaXN0KGRhdGEudXNlcnMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sXG4gICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ1dlYlNvY2tldCDRgdC+0LXQtNC40L3QtdC90LjQtSDQvtGC0LrRgNGL0YLQvicpO1xuICAgICAgICAgICAgY2hhdFNvY2tldC5zZW5kKHtcbiAgICAgICAgICAgICAgdHlwZTogJ3JlZ2lzdGVyJyxcbiAgICAgICAgICAgICAgdXNlcjogbmlja25hbWUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9LFxuICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdXZWJTb2NrZXQg0YHQvtC10LTQuNC90LXQvdC40LUg0LfQsNC60YDRi9GC0L4nKTtcbiAgICAgICAgICB9LFxuICAgICAgICApO1xuICAgICAgICBjaGF0VUkub24oJ3NlbmQtbWVzc2FnZScsIChtZXNzYWdlKSA9PiB7XG4gICAgICAgICAgY2hhdFNvY2tldC5zZW5kKHtcbiAgICAgICAgICAgIHR5cGU6ICdzZW5kJyxcbiAgICAgICAgICAgIHVzZXI6IGNoYXRVSS5uaWNrbmFtZSxcbiAgICAgICAgICAgIGNvbnRlbnQ6IG1lc3NhZ2UuY29udGVudCxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdiZWZvcmV1bmxvYWQnLCAoKSA9PiBjaGF0VUkuZGlzY29ubmVjdCgpKTtcbiAgICAgICAgY2hhdFVJLmVtaXQoJ2xvYWQnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFsZXJ0KGDQntGI0LjQsdC60LAg0YDQtdCz0LjRgdGC0YDQsNGG0LjQuDogJHtyZXNwb25zZS5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBhbGVydChg0J7RiNC40LHQutCwINGA0LXQs9C40YHRgtGA0LDRhtC40Lg6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICB9XG4gIH0pO1xufTtcbmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBzaG93UmVnaXN0cmF0aW9uV2luZG93KTtcbiIsImV4cG9ydCBkZWZhdWx0IGNsYXNzIENoYXRBUEkge1xuICBjb25zdHJ1Y3Rvcih1cmwpIHtcbiAgICB0aGlzLnVybCA9IHVybDtcbiAgfVxuXG4gIGFzeW5jIHJlZ2lzdGVyVXNlcihuaWNrbmFtZSkge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYCR7dGhpcy51cmx9L3JlZ2lzdGVyYCwge1xuICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICB9LFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBuaWNrbmFtZSB9KSxcbiAgICB9KTtcblxuICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgIGNvbnN0IGVycm9yID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yLnN0YXR1cyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgfVxuXG4gIGFzeW5jIHNlbmRNZXNzYWdlKG1lc3NhZ2UpIHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKGAke3RoaXMudXJsfS9zZW5kYCwge1xuICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICB9LFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlIH0pLFxuICAgIH0pO1xuXG4gICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gc2VuZCBtZXNzYWdlJyk7XG4gICAgfVxuICB9XG59XG4iLCIvKiBlc2xpbnQtZGlzYWJsZSBjbGFzcy1tZXRob2RzLXVzZS10aGlzICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDcmVhdGVET01FbGVtZW50cyB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMucmVnaXN0cmF0aW9uRm9ybSA9IHRoaXMuY3JlYXRlUmVnaXN0cmF0aW9uRm9ybSgpO1xuICB9XG5cbiAgY3JlYXRlUmVnaXN0cmF0aW9uRm9ybSgpIHtcbiAgICBjb25zdCBmb3JtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZm9ybScpO1xuICAgIGNvbnN0IGxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGFiZWwnKTtcbiAgICBsYWJlbC50ZXh0Q29udGVudCA9ICfQktGL0LHQtdGA0LjRgtC1INC/0YHQtdCy0LTQvtC90LjQvCc7XG4gICAgZm9ybS5hcHBlbmRDaGlsZChsYWJlbCk7XG5cbiAgICBjb25zdCBuaWNrbmFtZUlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTtcbiAgICBuaWNrbmFtZUlucHV0LnR5cGUgPSAndGV4dCc7XG4gICAgbmlja25hbWVJbnB1dC5pZCA9ICduaWNrbmFtZSc7XG4gICAgbGFiZWwuc2V0QXR0cmlidXRlKCdmb3InLCAnbmlja25hbWUnKTtcbiAgICBmb3JtLmFwcGVuZENoaWxkKG5pY2tuYW1lSW5wdXQpO1xuXG4gICAgY29uc3Qgc3VibWl0QnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7XG4gICAgc3VibWl0QnV0dG9uLnR5cGUgPSAnc3VibWl0JztcbiAgICBzdWJtaXRCdXR0b24udGV4dENvbnRlbnQgPSAn0J/RgNC+0LTQvtC70LbQuNGC0YwnO1xuICAgIGZvcm0uYXBwZW5kQ2hpbGQoc3VibWl0QnV0dG9uKTtcblxuICAgIHJldHVybiBmb3JtO1xuICB9XG5cbiAgY3JlYXRlTWVzc2FnZUZvcm0oKSB7XG4gICAgY29uc3QgZm9ybSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2Zvcm0nKTtcbiAgICBmb3JtLmlkID0gJ21lc3NhZ2UtZm9ybSc7XG5cbiAgICBjb25zdCBtZXNzYWdlSW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpO1xuICAgIG1lc3NhZ2VJbnB1dC5pZCA9ICdtZXNzYWdlLWlucHV0JztcbiAgICBtZXNzYWdlSW5wdXQudHlwZSA9ICd0ZXh0JztcbiAgICBmb3JtLmFwcGVuZENoaWxkKG1lc3NhZ2VJbnB1dCk7XG5cbiAgICByZXR1cm4gZm9ybTtcbiAgfVxuXG4gIGNyZWF0ZU1lc3NhZ2VzQ29udGFpbmVyKCkge1xuICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgIGRpdi5pZCA9ICdtZXNzYWdlcy1jb250YWluZXInO1xuICAgIHJldHVybiBkaXY7XG4gIH1cblxuICBjcmVhdGVVc2Vyc0xpc3QoKSB7XG4gICAgY29uc3QgdWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd1bCcpO1xuICAgIHVsLmlkID0gJ3VzZXJzLWxpc3QnO1xuICAgIHJldHVybiB1bDtcbiAgfVxuXG4gIGFwcGVuZFRvRE9NKCkge1xuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5yZWdpc3RyYXRpb25Gb3JtKTtcbiAgfVxuXG4gIGFwcGVuZE1lc3NhZ2VGb3JtQW5kVXNlcnNMaXN0VG9ET00oKSB7XG4gICAgdGhpcy51c2Vyc0xpc3QgPSB0aGlzLmNyZWF0ZVVzZXJzTGlzdCgpO1xuICAgIGNvbnN0IGNoYXRDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICBjaGF0Q29udGFpbmVyLmlkID0gJ2NoYXQtY29udGFpbmVyJztcbiAgICB0aGlzLm1lc3NhZ2VzQ29udGFpbmVyID0gdGhpcy5jcmVhdGVNZXNzYWdlc0NvbnRhaW5lcigpO1xuICAgIGNoYXRDb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5tZXNzYWdlc0NvbnRhaW5lcik7XG4gICAgdGhpcy5tZXNzYWdlRm9ybSA9IHRoaXMuY3JlYXRlTWVzc2FnZUZvcm0oKTtcbiAgICBjaGF0Q29udGFpbmVyLmFwcGVuZENoaWxkKHRoaXMubWVzc2FnZUZvcm0pO1xuXG4gICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLnVzZXJzTGlzdCk7XG4gICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChjaGF0Q29udGFpbmVyKTtcbiAgfVxuXG4gIHJlbW92ZVJlZ2lzdHJhdGlvbkZvcm0oKSB7XG4gICAgaWYgKGRvY3VtZW50LmJvZHkuY29udGFpbnModGhpcy5yZWdpc3RyYXRpb25Gb3JtKSkge1xuICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLnJlZ2lzdHJhdGlvbkZvcm0pO1xuICAgIH1cbiAgfVxuXG4gIHJlbW92ZU1lc3NhZ2VGb3JtKCkge1xuICAgIGlmIChkb2N1bWVudC5ib2R5LmNvbnRhaW5zKHRoaXMubWVzc2FnZUZvcm0pKSB7XG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMubWVzc2FnZUZvcm0pO1xuICAgIH1cbiAgfVxufVxuIl0sIm5hbWVzIjpbIkNoYXRVSSIsImNvbnN0cnVjdG9yIiwibmlja25hbWUiLCJ0aGlzIiwiaW5pdCIsIm1lc3NhZ2VGb3JtIiwiZG9jdW1lbnQiLCJnZXRFbGVtZW50QnlJZCIsIm1lc3NhZ2VJbnB1dCIsIm1lc3NhZ2VzQ29udGFpbmVyIiwidXNlcnNMaXN0IiwiYWRkRXZlbnRMaXN0ZW5lciIsImhhbmRsZVN1Ym1pdCIsImJpbmQiLCJoYW5kbGVFbnRlclByZXNzIiwiY29uc29sZSIsImVycm9yIiwiZXZlbnQiLCJwcmV2ZW50RGVmYXVsdCIsInNlbmRNZXNzYWdlIiwia2V5IiwibWVzc2FnZSIsInZhbHVlIiwidHJpbSIsImVtaXQiLCJ0eXBlIiwidXNlciIsImNvbnRlbnQiLCJ1cGRhdGVVc2Vyc0xpc3QiLCJ1c2VycyIsImlubmVySFRNTCIsImZvckVhY2giLCJ1c2VySXRlbSIsImNyZWF0ZUVsZW1lbnQiLCJ0ZXh0Q29udGVudCIsImNsYXNzTGlzdCIsImFkZCIsImFwcGVuZENoaWxkIiwidXBkYXRlTWVzc2FnZXMiLCJtZXNzYWdlcyIsIm1lc3NhZ2VEaXYiLCJ1c2VyU3BhbiIsImNvbW1hVGV4dCIsInRpbWVTcGFuIiwidGltZSIsImxpbmVCcmVhayIsImNvbnRlbnRUZXh0IiwiY3JlYXRlVGV4dE5vZGUiLCJzY3JvbGxUb0JvdHRvbSIsInNldFRpbWVvdXQiLCJzY3JvbGxUb3AiLCJzY3JvbGxIZWlnaHQiLCJkaXNjb25uZWN0Iiwib24iLCJjYWxsYmFjayIsImNhbGxiYWNrcyIsInB1c2giLCJkYXRhIiwiQ2hhdFdlYlNvY2tldCIsInVybCIsIm9uTWVzc2FnZSIsIm9uT3BlbiIsIm9uQ2xvc2UiLCJzb2NrZXQiLCJXZWJTb2NrZXQiLCJKU09OIiwicGFyc2UiLCJzZW5kIiwic3RyaW5naWZ5IiwiY2xvc2UiLCJjaGF0QVBJIiwicmVnaXN0ZXJVc2VyIiwicmVzcG9uc2UiLCJmZXRjaCIsIm1ldGhvZCIsImhlYWRlcnMiLCJib2R5Iiwib2siLCJqc29uIiwiRXJyb3IiLCJzdGF0dXMiLCJkb21FbGVtZW50cyIsInJlZ2lzdHJhdGlvbkZvcm0iLCJjcmVhdGVSZWdpc3RyYXRpb25Gb3JtIiwiZm9ybSIsImxhYmVsIiwibmlja25hbWVJbnB1dCIsImlkIiwic2V0QXR0cmlidXRlIiwic3VibWl0QnV0dG9uIiwiY3JlYXRlTWVzc2FnZUZvcm0iLCJjcmVhdGVNZXNzYWdlc0NvbnRhaW5lciIsImRpdiIsImNyZWF0ZVVzZXJzTGlzdCIsInVsIiwiYXBwZW5kVG9ET00iLCJhcHBlbmRNZXNzYWdlRm9ybUFuZFVzZXJzTGlzdFRvRE9NIiwiY2hhdENvbnRhaW5lciIsInJlbW92ZVJlZ2lzdHJhdGlvbkZvcm0iLCJjb250YWlucyIsInJlbW92ZUNoaWxkIiwicmVtb3ZlTWVzc2FnZUZvcm0iLCJjaGF0VUkiLCJzaG93UmVnaXN0cmF0aW9uV2luZG93IiwiYXN5bmMiLCJxdWVyeVNlbGVjdG9yIiwiYWxlcnQiLCJjaGF0U29ja2V0IiwibG9nIiwid2luZG93Il0sInNvdXJjZVJvb3QiOiIifQ==